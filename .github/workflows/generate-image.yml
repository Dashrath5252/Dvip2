name: Generate Responsive Images

on:
  push:
    paths:
      - 'dvip1.webp'
      - 'dvip2.webp'
      - 'dvip3.webp'
      - 'dvip4.webp'
      - 'dvipicon*.webp'
  workflow_dispatch:  # Manual trigger

jobs:
  generate-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install Pillow
      run: |
        python -m pip install --upgrade pip
        pip install Pillow==10.1.0
    
    - name: Create directories
      run: |
        # Create main directories
        mkdir -p dvip1 dvip2 dvip3 dvip4 dvipicon
        
        # Create resized subdirectories
        mkdir -p dvip1/resized dvip2/resized dvip3/resized dvip4/resized dvipicon/resized
        
        # Create sizes directory for HTML
        mkdir -p sizes
    
    - name: Copy default images to directories
      run: |
        echo "üìã Copying default images..."
        
        # Copy each default image to its directory
        [ -f "dvip1.webp" ] && cp dvip1.webp dvip1/ && echo "‚úì dvip1.webp copied"
        [ -f "dvip2.webp" ] && cp dvip2.webp dvip2/ && echo "‚úì dvip2.webp copied"
        [ -f "dvip3.webp" ] && cp dvip3.webp dvip3/ && echo "‚úì dvip3.webp copied"
        [ -f "dvip4.webp" ] && cp dvip4.webp dvip4/ && echo "‚úì dvip4.webp copied"
        
        # Copy icon files
        [ -f "dvipicon512.webp" ] && cp dvipicon512.webp dvipicon/ && echo "‚úì dvipicon512.webp copied"
        [ -f "dvipicon180.webp" ] && cp dvipicon180.webp dvipicon/ && echo "‚úì dvipicon180.webp copied"
        [ -f "dvipicon48.webp" ] && cp dvipicon48.webp dvipicon/ && echo "‚úì dvipicon48.webp copied"
    
    - name: Generate responsive images using inline Python
      run: |
        echo "üöÄ Generating responsive images..."
        python -c "
import os
import sys
from pathlib import Path
from PIL import Image
import json

print('üìÅ Starting image generation...')

# Image sizes
REGULAR_SIZES = [320, 480, 640, 768, 1024, 1280, 1536]
ICON_SIZES = [48, 72, 96, 128, 180, 192, 256, 512]

# Process each directory
directories = {
    'dvip1': 'dvip1.webp',
    'dvip2': 'dvip2.webp', 
    'dvip3': 'dvip3.webp',
    'dvip4': 'dvip4.webp',
    'dvipicon': 'dvipicon512.webp'
}

all_generated = {}

for dir_name, source_file in directories.items():
    print(f'\\nüìÅ Processing {dir_name}...')
    
    source_path = Path(dir_name) / source_file
    
    if not source_path.exists():
        print(f'  ‚ö†Ô∏è  {source_file} not found in {dir_name}/')
        continue
    
    try:
        with Image.open(source_path) as img:
            # Convert to RGB if needed
            if img.mode != 'RGB':
                img = img.convert('RGB')
            
            original_width, original_height = img.size
            is_icon = dir_name == 'dvipicon'
            sizes = ICON_SIZES if is_icon else REGULAR_SIZES
            
            generated = []
            
            for size in sizes:
                if is_icon:
                    # For icons, create square
                    new_width = size
                    new_height = size
                    filename = f'{source_path.stem}-{size}x{size}.webp'
                else:
                    # For regular images, maintain aspect ratio
                    if size > original_width:
                        continue  # Don't upscale
                    ratio = size / original_width
                    new_width = size
                    new_height = int(original_height * ratio)
                    filename = f'{source_path.stem}-{size}w.webp'
                
                # Resize image
                resized = img.resize((new_width, new_height), Image.Resampling.LANCZOS)
                
                # Save as WebP
                output_path = Path(dir_name) / 'resized' / filename
                resized.save(output_path, 'WEBP', quality=85, optimize=True)
                
                generated.append({
                    'size': size,
                    'width': new_width,
                    'height': new_height,
                    'filename': filename
                })
                
                print(f'  ‚úì {filename} ({new_width}x{new_height})')
            
            all_generated[dir_name] = generated
            
    except Exception as e:
        print(f'  ‚ùå Error: {e}')

print('\\n‚úÖ All images generated!')

# Save manifest
with open('image-manifest.json', 'w') as f:
    json.dump({
        'generated': all_generated,
        'timestamp': '$(date -Iseconds)'
    }, f, indent=2)

print('üìÑ Manifest saved: image-manifest.json')
"
    
    - name: Generate HTML code
      run: |
        echo "üõ†Ô∏è Generating HTML code..."
        python -c "
from pathlib import Path
import json

print('Creating HTML snippets...')

# Create sizes directory if it doesn't exist
Path('sizes').mkdir(exist_ok=True)

directories = ['dvip1', 'dvip2', 'dvip3', 'dvip4', 'dvipicon']

for dir_name in directories:
    print(f'\\nüìÅ Creating HTML for {dir_name}...')
    
    # Find original image
    dir_path = Path(dir_name)
    if not dir_path.exists():
        continue
    
    webp_files = list(dir_path.glob('*.webp'))
    if not webp_files:
        continue
    
    original_file = webp_files[0]
    image_name = original_file.stem
    
    # Check if resized folder exists
    resized_dir = dir_path / 'resized'
    if not resized_dir.exists():
        print(f'  ‚ö†Ô∏è No resized images found for {dir_name}')
        continue
    
    # Get all resized images
    resized_images = list(resized_dir.glob('*.webp'))
    
    # Generate srcset
    srcset_parts = []
    for img in resized_images:
        # Extract size from filename
        name = img.stem
        if 'x' in name:  # Icon format: name-48x48
            size = name.split('-')[-1].split('x')[0]
            srcset_parts.append(f'/{dir_name}/resized/{img.name} {size}w')
        elif 'w' in name:  # Regular format: name-320w
            size = name.split('-')[-1].replace('w', '')
            srcset_parts.append(f'/{dir_name}/resized/{img.name} {size}w')
    
    # Add original image
    srcset_parts.append(f'/{dir_name}/{original_file.name} original')
    
    if dir_name == 'dvipicon':
        html = f'''<img 
    src=\"/{dir_name}/{original_file.name}\" 
    srcset=\"{', '.join(srcset_parts)}\"
    sizes=\"(max-width: 48px) 48px, (max-width: 96px) 96px, 128px\"
    alt=\"{dir_name} icon\"
    width=\"512\"
    height=\"512\"
    loading=\"lazy\"
    class=\"responsive-icon\"
>'''
    else:
        html = f'''<img 
    src=\"/{dir_name}/resized/{image_name}-640w.webp\" 
    srcset=\"{', '.join(srcset_parts)}\"
    sizes=\"(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw\"
    alt=\"{dir_name} image\"
    width=\"1024\"
    height=\"auto\"
    loading=\"lazy\"
    class=\"responsive-image\"
>'''
    
    # Save HTML snippet
    output_file = f'sizes/{dir_name}-srcset.html'
    with open(output_file, 'w') as f:
        f.write(html)
    
    print(f'  ‚úì HTML saved: {output_file}')
    
    # Create simple demo
    demo_html = f'''<!DOCTYPE html>
<html>
<head>
    <title>{dir_name} - Responsive Image</title>
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">
    <style>
        body {{ font-family: Arial, sans-serif; padding: 20px; }}
        img {{ max-width: 100%; height: auto; }}
        pre {{ background: #f5f5f5; padding: 10px; }}
    </style>
</head>
<body>
    <h1>{dir_name}</h1>
    {html}
    <h3>HTML Code:</h3>
    <pre>{html}</pre>
</body>
</html>'''
    
    with open(f'sizes/{dir_name}-demo.html', 'w') as f:
        f.write(demo_html)

print('\\n‚úÖ HTML generation completed!')
"
    
    - name: List generated files
      run: |
        echo "üìÅ Generated Files Structure:"
        echo "=============================="
        
        echo "1. Image directories:"
        for dir in dvip1 dvip2 dvip3 dvip4 dvipicon; do
          if [ -d "$dir" ]; then
            echo "   üìÇ $dir/"
            if [ -d "$dir/resized" ]; then
              count=$(ls -1 "$dir/resized/"*.webp 2>/dev/null | wc -l)
              echo "      ‚îî‚îÄ‚îÄ resized/ ($count images)"
            fi
          fi
        done
        
        echo ""
        echo "2. HTML files in sizes/:"
        ls -la sizes/ 2>/dev/null || echo "   No sizes directory"
        
        echo ""
        echo "3. Manifest:"
        [ -f "image-manifest.json" ] && echo "   ‚úì image-manifest.json" || echo "   ‚úó No manifest"
    
    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .
        git diff --quiet && git diff --staged --quiet || git commit -m "üñºÔ∏è Auto-generated responsive images [skip ci]"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

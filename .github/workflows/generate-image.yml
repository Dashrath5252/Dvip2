#!/usr/bin/env python3
"""
Generate responsive images from default images for each directory
"""

import os
import sys
from pathlib import Path
from PIL import Image
import json
import shutil

# Responsive sizes (width only, height auto)
RESPONSIVE_SIZES = [180, 320, 480, 640, 768, 1024, 1280, 1536, 1920, 2560]

# Icon sizes for dvipicon
ICON_SIZES = [16, 32, 48, 72, 96, 128, 180, 192, 256, 512]

# WebP quality
WEBP_QUALITY = 85

def generate_responsive_images(source_image, output_dir, is_icon=False):
    """Generate responsive images from source"""
    
    if not Path(source_image).exists():
        print(f"‚ö†Ô∏è  Source image not found: {source_image}")
        return []
    
    sizes = ICON_SIZES if is_icon else RESPONSIVE_SIZES
    
    generated_files = []
    
    try:
        with Image.open(source_image) as img:
            # Convert to RGB if necessary
            if img.mode != 'RGB':
                img = img.convert('RGB')
            
            original_width, original_height = img.size
            
            for size in sizes:
                if size > original_width and not is_icon:
                    continue  # Don't upscale regular images
                
                # Calculate proportional height
                if is_icon:
                    new_width = size
                    new_height = size
                else:
                    ratio = size / original_width
                    new_width = size
                    new_height = int(original_height * ratio)
                
                # Resize image
                resized = img.resize((new_width, new_height), Image.Resampling.LANCZOS)
                
                # Generate filename
                source_stem = Path(source_image).stem
                if is_icon:
                    filename = f"{source_stem}-{size}x{size}.webp"
                else:
                    filename = f"{source_stem}-{size}w.webp"
                
                output_path = Path(output_dir) / 'resized' / filename
                
                # Ensure directory exists
                output_path.parent.mkdir(parents=True, exist_ok=True)
                
                # Save as WebP
                resized.save(
                    output_path,
                    'WEBP',
                    quality=WEBP_QUALITY,
                    optimize=True,
                    method=6
                )
                
                generated_files.append({
                    'size': size,
                    'width': new_width,
                    'height': new_height,
                    'filename': filename,
                    'path': str(output_path.relative_to(Path.cwd()))
                })
                
                print(f"  ‚úì Generated: {filename} ({new_width}x{new_height})")
    
    except Exception as e:
        print(f"‚ùå Error processing {source_image}: {e}")
        import traceback
        traceback.print_exc()
    
    return generated_files

def ensure_directories():
    """Create all necessary directories"""
    directories = ['dvip1', 'dvip2', 'dvip3', 'dvip4', 'dvipicon', 'scripts', 'sizes']
    
    for dir_name in directories:
        Path(dir_name).mkdir(exist_ok=True)
        
        # Create resized subdirectory for image folders
        if dir_name in ['dvip1', 'dvip2', 'dvip3', 'dvip4', 'dvipicon']:
            (Path(dir_name) / 'resized').mkdir(exist_ok=True)

def copy_default_images():
    """Copy default images from root to respective directories"""
    print("üìã Copying default images...")
    
    default_images = {
        'dvip1': 'dvip1.webp',
        'dvip2': 'dvip2.webp',
        'dvip3': 'dvip3.webp',
        'dvip4': 'dvip4.webp',
        'dvipicon': 'dvipicon512.webp'
    }
    
    for folder, image_file in default_images.items():
        source = Path(image_file)
        if source.exists():
            # Copy to folder
            dest_folder = Path(folder)
            dest_folder.mkdir(exist_ok=True)
            shutil.copy2(source, dest_folder / image_file)
            print(f"  ‚úì Copied {image_file} to {folder}/")
        else:
            print(f"  ‚ö†Ô∏è  {image_file} not found in root")

def main():
    """Main function to process all directories"""
    
    print("üöÄ Starting responsive image generation...")
    print("=" * 50)
    
    # Ensure directories exist
    ensure_directories()
    
    # Copy default images first
    copy_default_images()
    
    # Directory configuration
    directories = {
        'dvip1': 'dvip1.webp',
        'dvip2': 'dvip2.webp',
        'dvip3': 'dvip3.webp',
        'dvip4': 'dvip4.webp',
        'dvipicon': 'dvipicon512.webp'
    }
    
    all_generated = {}
    
    for dir_name, image_file in directories.items():
        print(f"\nüìÅ Processing {dir_name}...")
        
        source_path = Path(dir_name) / image_file
        
        if not source_path.exists():
            print(f"  ‚ö†Ô∏è  Source not found: {source_path}")
            continue
        
        # Generate images
        is_icon = dir_name == 'dvipicon'
        generated = generate_responsive_images(
            str(source_path),
            dir_name,
            is_icon=is_icon
        )
        
        all_generated[dir_name] = generated
        
        if generated:
            print(f"  ‚úÖ Generated {len(generated)} images for {dir_name}")
        else:
            print(f"  ‚ùå No images generated for {dir_name}")
    
    # Generate manifest file
    manifest = {
        'generated': all_generated,
        'directories': list(directories.keys()),
        'timestamp': str(Path(__file__).stat().st_mtime)
    }
    
    with open('image-manifest.json', 'w') as f:
        json.dump(manifest, f, indent=2)
    
    print("\n" + "=" * 50)
    print("‚úÖ Image generation completed!")
    print(f"üìÅ Check the 'resized' folder in each directory")
    print("üìÑ Manifest saved: image-manifest.json")
    print("=" * 50)
    
    # Return success
    sys.exit(0)

if __name__ == "__main__":
    main()

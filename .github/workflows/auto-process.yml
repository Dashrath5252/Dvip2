name: Auto Process New DVIP Images

on:
  push:
    paths:
      - '*.webp'           # à¤¸à¤¿à¤°à¥à¤« new webp files à¤ªà¤° trigger
  workflow_dispatch:       # Manual run à¤•à¥‡ à¤²à¤¿à¤

jobs:
  process-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Setup WebP tools
      run: |
        sudo apt-get update
        sudo apt-get install -y webp
        
    - name: Create processing folders
      run: |
        mkdir -p _lqip _thumbs _medium _high
        
    - name: Process ONLY DVIP images (1-9)
      run: |
        echo "ðŸ“¸ Processing DVIP images..."
        
        # dvip1.webp à¤¸à¥‡ dvip9.webp à¤¤à¤• process à¤•à¤°à¥‡à¤‚
        for i in {1..9}; do
          if [ -f "dvip${i}.webp" ]; then
            echo "Processing dvip${i}.webp..."
            
            # 1. LQIP (Low Quality Image Placeholder) - à¤¬à¥à¤²à¤° preview
            cwebp "dvip${i}.webp" -q 10 -resize 20 20 -blur 10 -o "_lqip/dvip${i}-lq.webp"
            
            # 2. Thumbnail (150x150)
            cwebp "dvip${i}.webp" -q 40 -resize 150 150 -o "_thumbs/dvip${i}-thumb.webp"
            
            # 3. Medium (800px width, 60% quality)
            cwebp "dvip${i}.webp" -q 60 -resize 800 0 -o "_medium/dvip${i}-medium.webp"
            
            # 4. High (90% quality, original ratio)
            cwebp "dvip${i}.webp" -q 90 -o "_high/dvip${i}-high.webp"
            
            echo "âœ… dvip${i}.webp processed"
          fi
        done
        
    - name: Process dvipicon512.webp
      run: |
        if [ -f "dvipicon512.webp" ]; then
          echo "Processing icon..."
          cwebp "dvipicon512.webp" -q 80 -resize 64 64 -o "_thumbs/icon-thumb.webp"
        fi
        
    - name: Generate/Update HTML automatically
      run: |
        # Find all dvip images
        images=()
        for i in {1..9}; do
          if [ -f "dvip${i}.webp" ]; then
            images+=("dvip${i}")
          fi
        done
        
        echo "Found images: ${images[@]}"
        
        # HTML generate à¤•à¤°à¥‡à¤‚
        cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>DVIP Gallery</title>
            <link rel="icon" type="image/webp" href="_thumbs/icon-thumb.webp">
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    padding: 20px;
                }
                .header {
                    text-align: center;
                    color: white;
                    margin-bottom: 30px;
                    padding: 20px;
                }
                .header h1 {
                    font-size: 2.5rem;
                    margin-bottom: 10px;
                    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                }
                .loading-status {
                    background: rgba(255,255,255,0.9);
                    padding: 10px;
                    border-radius: 8px;
                    margin: 10px auto;
                    max-width: 600px;
                    text-align: center;
                    color: #333;
                }
                .gallery {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                    gap: 20px;
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 20px;
                    background: rgba(255,255,255,0.95);
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                }
                .image-box {
                    position: relative;
                    border-radius: 10px;
                    overflow: hidden;
                    cursor: pointer;
                    height: 200px;
                    background: #f0f0f0;
                    transition: all 0.3s;
                }
                .image-box:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 15px 30px rgba(0,0,0,0.3);
                }
                .image-box img {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                    transition: all 0.5s ease;
                }
                .image-box.loading img {
                    filter: blur(15px);
                    transform: scale(1.1);
                }
                .image-box.loaded img {
                    filter: blur(0);
                    transform: scale(1);
                }
                .quality-badge {
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: rgba(0,0,0,0.7);
                    color: white;
                    padding: 3px 10px;
                    border-radius: 12px;
                    font-size: 12px;
                    font-weight: bold;
                }
                .lightbox {
                    display: none;
                    position: fixed;
                    top: 0; left: 0;
                    width: 100%; height: 100%;
                    background: rgba(0,0,0,0.95);
                    z-index: 1000;
                    justify-content: center;
                    align-items: center;
                }
                .lightbox img {
                    max-width: 90%;
                    max-height: 90%;
                    border-radius: 10px;
                    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
                }
                .close-btn {
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    color: white;
                    font-size: 40px;
                    cursor: pointer;
                    background: none;
                    border: none;
                }
                .image-name {
                    position: absolute;
                    bottom: -40px;
                    left: 0;
                    right: 0;
                    text-align: center;
                    color: white;
                    font-size: 18px;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>DVIP Progressive Gallery</h1>
                <div class="loading-status">
                    <strong>WordPress-style Loading:</strong> 
                    <span id="status">Loading previews...</span>
                </div>
            </div>
            
            <div class="gallery" id="gallery">
                <!-- Images will be auto-inserted here -->
            </div>
            
            <div class="lightbox" id="lightbox">
                <button class="close-btn" onclick="closeLightbox()">Ã—</button>
                <img id="lightbox-img" src="" alt="">
                <div class="image-name" id="lightbox-name"></div>
            </div>
            
            <script>
                // Images data - AUTO-GENERATED
                const images = [
        EOF
        
        # Add each image to the JavaScript array
        for img in "${images[@]}"; do
          echo "                    {name: '${img}', lq: '_lqip/${img}-lq.webp', med: '_medium/${img}-medium.webp', high: '_high/${img}-high.webp', thumb: '_thumbs/${img}-thumb.webp'}," >> index.html
        done
        
        cat >> index.html << 'EOF'
                ];
                
                let progressiveLoading = true;
                
                // WordPress-style Progressive Image Loader
                class ProgressiveLoader {
                    constructor() {
                        this.gallery = document.getElementById('gallery');
                        this.status = document.getElementById('status');
                        this.init();
                    }
                    
                    init() {
                        this.renderGallery();
                        this.setupLightbox();
                        this.startProgressiveLoading();
                    }
                    
                    renderGallery() {
                        this.gallery.innerHTML = '';
                        
                        images.forEach((img, index) => {
                            const div = document.createElement('div');
                            div.className = 'image-box loading';
                            div.dataset.index = index;
                            
                            div.innerHTML = `
                                <div class="quality-badge">LQIP</div>
                                <img 
                                    src="${img.lq}" 
                                    data-med="${img.med}"
                                    data-high="${img.high}"
                                    alt="${img.name}"
                                    loading="lazy"
                                />
                            `;
                            
                            this.gallery.appendChild(div);
                        });
                        
                        this.status.textContent = `Loaded ${images.length} images (Low quality preview)`;
                    }
                    
                    startProgressiveLoading() {
                        const imageBoxes = document.querySelectorAll('.image-box');
                        
                        imageBoxes.forEach((box, index) => {
                            setTimeout(() => {
                                this.loadMediumQuality(box, index);
                            }, index * 300); // Stagger loading
                        });
                    }
                    
                    loadMediumQuality(box, index) {
                        const img = box.querySelector('img');
                        const medSrc = img.dataset.med;
                        
                        const mediumImg = new Image();
                        mediumImg.onload = () => {
                            img.src = medSrc;
                            box.classList.remove('loading');
                            box.classList.add('loaded');
                            box.querySelector('.quality-badge').textContent = 'MEDIUM';
                            box.querySelector('.quality-badge').style.background = 'rgba(59, 130, 246, 0.8)';
                            
                            // Load high quality after delay
                            setTimeout(() => {
                                this.loadHighQuality(box, index);
                            }, 1000);
                        };
                        mediumImg.src = medSrc;
                    }
                    
                    loadHighQuality(box, index) {
                        const img = box.querySelector('img');
                        const highSrc = img.dataset.high;
                        
                        const highImg = new Image();
                        highImg.onload = () => {
                            img.src = highSrc;
                            box.querySelector('.quality-badge').textContent = 'HIGH';
                            box.querySelector('.quality-badge').style.background = 'rgba(34, 197, 94, 0.8)';
                            
                            // Store for lightbox
                            box.dataset.highSrc = highSrc;
                        };
                        highImg.src = highSrc;
                    }
                    
                    setupLightbox() {
                        document.addEventListener('click', (e) => {
                            const box = e.target.closest('.image-box');
                            if (box) {
                                const index = box.dataset.index;
                                this.openLightbox(index);
                            }
                        });
                    }
                    
                    openLightbox(index) {
                        const imgData = images[index];
                        const lightbox = document.getElementById('lightbox');
                        const lightboxImg = document.getElementById('lightbox-img');
                        const lightboxName = document.getElementById('lightbox-name');
                        
                        // Show medium quality first
                        lightboxImg.src = imgData.med;
                        lightboxName.textContent = imgData.name;
                        lightbox.style.display = 'flex';
                        
                        // Then load high quality
                        setTimeout(() => {
                            lightboxImg.src = imgData.high;
                        }, 300);
                    }
                }
                
                function closeLightbox() {
                    document.getElementById('lightbox').style.display = 'none';
                }
                
                // Escape key to close lightbox
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        closeLightbox();
                    }
                });
                
                // Initialize on page load
                document.addEventListener('DOMContentLoaded', () => {
                    new ProgressiveLoader();
                });
            </script>
        </body>
        </html>
        EOF
        
        echo "âœ… index.html updated with ${#images[@]} images"
        
    - name: Create robots.txt if not exists
      run: |
        if [ ! -f "robots.txt" ]; then
          echo "User-agent: *" > robots.txt
          echo "Allow: /" >> robots.txt
          echo "Sitemap: https://YOUR_USERNAME.github.io/YOUR_REPO/sitemap.xml" >> robots.txt
        fi
        
    - name: Create manifest file
      run: |
        # Create JSON manifest
        cat > _processed.json << 'EOF'
        {
          "last_processed": "$(date -Iseconds)",
          "total_images": $(ls dvip*.webp 2>/dev/null | wc -l),
          "images": [
        EOF
        
        for i in {1..9}; do
          if [ -f "dvip${i}.webp" ]; then
            echo "    {\"name\": \"dvip${i}\", \"original\": \"dvip${i}.webp\", \"processed\": true}," >> _processed.json
          fi
        done
        
        cat >> _processed.json << 'EOF'
          ],
          "icon_processed": true
        }
        EOF
        
    - name: Commit processed files
      run: |
        git config --local user.email "github-actions@users.noreply.github.com"
        git config --local user.name "GitHub Actions"
        
        # Add only processed folders and updated files
        git add _lqip/ _thumbs/ _medium/ _high/ _processed.json index.html
        
        git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ”„ Auto-process DVIP images [$(date +%Y-%m-%d)]"
        git push

name: Generate Responsive Images

on:
  workflow_dispatch

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install Pillow
      run: pip install Pillow==10.1.0
    
    - name: Create directories
      run: |
        echo "üìÅ Creating directories..."
        mkdir -p dvip1/resized dvip2/resized dvip3/resized dvip4/resized dvipicon/resized
        mkdir -p sizes
        echo "‚úÖ Directories created"
    
    - name: Generate responsive images
      run: |
        echo "üöÄ Generating responsive images..."
        
        # Create and run Python script
        python3 -c "
import os
import sys
from pathlib import Path
from PIL import Image
import json
import shutil

print('üìÅ Starting image generation...')

# Define sizes
REGULAR_SIZES = [320, 480, 640, 768, 1024, 1280, 1536]
ICON_SIZES = [48, 72, 96, 128, 180, 192, 256, 512]

# Map directories to source images
directories = {
    'dvip1': 'dvip1.webp',
    'dvip2': 'dvip2.webp', 
    'dvip3': 'dvip3.webp',
    'dvip4': 'dvip4.webp',
    'dvipicon': 'dvipicon512.webp'
}

all_generated = {}

for dir_name, source_file in directories.items():
    print(f'\\nüìÅ Processing {dir_name}...')
    
    source_path = Path(source_file)
    if not source_path.exists():
        print(f'  ‚ö†Ô∏è  {source_file} not found')
        continue
    
    # Copy original to directory
    Path(dir_name).mkdir(exist_ok=True)
    dest_path = Path(dir_name) / source_file
    if not dest_path.exists():
        shutil.copy2(source_path, dest_path)
        print(f'  ‚úì Copied to {dir_name}/')
    
    try:
        with Image.open(source_path) as img:
            if img.mode != 'RGB':
                img = img.convert('RGB')
            
            original_width, original_height = img.size
            is_icon = dir_name == 'dvipicon'
            sizes = ICON_SIZES if is_icon else REGULAR_SIZES
            
            generated = []
            
            for size in sizes:
                if is_icon:
                    # Square icon
                    new_width = size
                    new_height = size
                    filename = f'dvipicon{size}.webp'
                else:
                    # Regular image - maintain aspect
                    if size > original_width:
                        continue
                    ratio = size / original_width
                    new_width = size
                    new_height = int(original_height * ratio)
                    filename = f'{source_path.stem}-{size}w.webp'
                
                # Resize and save
                resized = img.resize((new_width, new_height), Image.Resampling.LANCZOS)
                output_path = Path(dir_name) / 'resized' / filename
                output_path.parent.mkdir(exist_ok=True)
                resized.save(output_path, 'WEBP', quality=85, optimize=True)
                
                generated.append({
                    'size': size,
                    'width': new_width,
                    'height': new_height,
                    'filename': filename
                })
                
                print(f'  ‚úì {filename} ({new_width}x{new_height})')
            
            all_generated[dir_name] = generated
            
    except Exception as e:
        print(f'  ‚ùå Error: {e}')

print('\\n‚úÖ All images generated!')

# Save manifest
with open('image-manifest.json', 'w') as f:
    json.dump({
        'generated': all_generated,
        'timestamp': '$(date -Iseconds)'
    }, f, indent=2)

print('üìÑ Manifest saved')
"
    
    - name: Generate HTML
      run: |
        echo "üõ†Ô∏è Generating HTML..."
        
        python3 -c "
from pathlib import Path
import json

print('Creating HTML snippets...')

Path('sizes').mkdir(exist_ok=True)

directories = ['dvip1', 'dvip2', 'dvip3', 'dvip4', 'dvipicon']

for dir_name in directories:
    print(f'\\nüìÅ {dir_name}')
    
    dir_path = Path(dir_name)
    if not dir_path.exists():
        continue
    
    # Find images
    webp_files = list(dir_path.glob('*.webp'))
    if not webp_files:
        continue
    
    original = webp_files[0].name
    image_name = webp_files[0].stem
    
    # Get resized images
    resized_dir = dir_path / 'resized'
    if not resized_dir.exists():
        continue
    
    resized = list(resized_dir.glob('*.webp'))
    
    # Build srcset
    srcset = []
    for img in resized:
        img_name = img.name
        if 'dvipicon' in img_name:
            if '48' in img_name:
                size = '48'
            elif '180' in img_name:
                size = '180'
            elif '512' in img_name:
                size = '512'
            else:
                continue
            srcset.append(f'/{dir_name}/resized/{img_name} {size}w')
        elif 'w' in img_name:
            size = img.stem.split('-')[-1].replace('w', '')
            srcset.append(f'/{dir_name}/resized/{img_name} {size}w')
    
    if not srcset:
        continue
    
    # Add original
    srcset.append(f'/{dir_name}/{original} original')
    
    # Create HTML
    if dir_name == 'dvipicon':
        html = f'''<img 
    src=\"/{dir_name}/{original}\" 
    srcset=\"{', '.join(srcset)}\"
    sizes=\"(max-width: 48px) 48px, (max-width: 96px) 96px, 128px\"
    alt=\"{dir_name} icon\"
    width=\"512\"
    height=\"512\"
    loading=\"lazy\"
>'''
    else:
        html = f'''<img 
    src=\"/{dir_name}/resized/{image_name}-640w.webp\" 
    srcset=\"{', '.join(srcset)}\"
    sizes=\"(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw\"
    alt=\"{dir_name} image\"
    width=\"1024\"
    height=\"auto\"
    loading=\"lazy\"
>'''
    
    # Save HTML
    with open(f'sizes/{dir_name}-srcset.html', 'w') as f:
        f.write(html)
    print(f'  ‚úì HTML saved')
    
    # Create demo
    demo = f'''<!DOCTYPE html>
<html>
<head>
    <title>{dir_name}</title>
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">
    <style>
        body {{ font-family: Arial; padding: 20px; }}
        img {{ max-width: 100%; }}
        pre {{ background: #f5f5f5; padding: 10px; }}
    </style>
</head>
<body>
    <h1>{dir_name}</h1>
    {html}
    <h3>Code:</h3>
    <pre>{html}</pre>
</body>
</html>'''
    
    with open(f'sizes/{dir_name}-demo.html', 'w') as f:
        f.write(demo)

print('\\n‚úÖ HTML generation complete!')
"
    
    - name: Show results
      run: |
        echo "üìä RESULTS:"
        echo ""
        echo "Images generated:"
        for dir in dvip1 dvip2 dvip3 dvip4 dvipicon; do
          if [ -d "$dir/resized" ]; then
            count=$(ls -1 "$dir/resized/"*.webp 2>/dev/null | wc -l)
            echo "  $dir/resized/: $count images"
          fi
        done
        
        echo ""
        echo "HTML files:"
        ls -la sizes/*.html 2>/dev/null || echo "  No HTML files"
        
        echo ""
        echo "Manifest:"
        [ -f "image-manifest.json" ] && echo "  ‚úì image-manifest.json" || echo "  ‚úó No manifest"
    
    - name: Commit changes
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        git add .
        
        if ! git diff --cached --quiet; then
          git commit -m "üñºÔ∏è Auto-generated responsive images"
          git push
        else
          echo "No changes to commit"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Generate Images

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install Pillow
      run: pip install Pillow
    
    - name: Create folders
      run: |
        mkdir -p dvip1/resized dvip2/resized dvip3/resized dvip4/resized dvipicon/resized
        mkdir -p html-templates
    
    - name: Process dvip1
      run: |
        if [ -f "dvip1.webp" ]; then
          python3 -c "
from PIL import Image
img = Image.open('dvip1.webp')
for size in [320, 640, 1024, 1536]:
    ratio = size / img.width
    h = int(img.height * ratio)
    resized = img.resize((size, h))
    resized.save(f'dvip1/resized/dvip1-{size}w.webp', 'WEBP', quality=85)
    print(f'dvip1-{size}w.webp created')
img.close()
"
        else
          echo "dvip1.webp not found"
        fi
    
    - name: Process dvip2
      run: |
        if [ -f "dvip2.webp" ]; then
          python3 -c "
from PIL import Image
img = Image.open('dvip2.webp')
for size in [320, 640, 1024, 1536]:
    ratio = size / img.width
    h = int(img.height * ratio)
    resized = img.resize((size, h))
    resized.save(f'dvip2/resized/dvip2-{size}w.webp', 'WEBP', quality=85)
    print(f'dvip2-{size}w.webp created')
img.close()
"
        else
          echo "dvip2.webp not found"
        fi
    
    - name: Process dvip3
      run: |
        if [ -f "dvip3.webp" ]; then
          python3 -c "
from PIL import Image
img = Image.open('dvip3.webp')
for size in [320, 640, 1024, 1536]:
    ratio = size / img.width
    h = int(img.height * ratio)
    resized = img.resize((size, h))
    resized.save(f'dvip3/resized/dvip3-{size}w.webp', 'WEBP', quality=85)
    print(f'dvip3-{size}w.webp created')
img.close()
"
        else
          echo "dvip3.webp not found"
        fi
    
    - name: Process dvip4
      run: |
        if [ -f "dvip4.webp" ]; then
          python3 -c "
from PIL import Image
img = Image.open('dvip4.webp')
for size in [320, 640, 1024, 1536]:
    ratio = size / img.width
    h = int(img.height * ratio)
    resized = img.resize((size, h))
    resized.save(f'dvip4/resized/dvip4-{size}w.webp', 'WEBP', quality=85)
    print(f'dvip4-{size}w.webp created')
img.close()
"
        else
          echo "dvip4.webp not found"
        fi
    
    - name: Process icons
      run: |
        if [ -f "dvipicon512.webp" ]; then
          python3 -c "
from PIL import Image
img = Image.open('dvipicon512.webp')
for size in [48, 180, 512]:
    resized = img.resize((size, size))
    resized.save(f'dvipicon/resized/dvipicon{size}.webp', 'WEBP', quality=85)
    print(f'dvipicon{size}.webp created')
img.close()
"
        else
          echo "dvipicon512.webp not found"
        fi
    
    - name: Create simple HTML
      run: |
        echo '<img src="/dvip1/resized/dvip1-640w.webp" srcset="/dvip1/resized/dvip1-320w.webp 320w, /dvip1/resized/dvip1-640w.webp 640w, /dvip1/resized/dvip1-1024w.webp 1024w" sizes="100vw" alt="dvip1">' > html-templates/dvip1.html
        echo '<img src="/dvip2/resized/dvip2-640w.webp" srcset="/dvip2/resized/dvip2-320w.webp 320w, /dvip2/resized/dvip2-640w.webp 640w, /dvip2/resized/dvip2-1024w.webp 1024w" sizes="100vw" alt="dvip2">' > html-templates/dvip2.html
        echo '<img src="/dvip3/resized/dvip3-640w.webp" srcset="/dvip3/resized/dvip3-320w.webp 320w, /dvip3/resized/dvip3-640w.webp 640w, /dvip3/resized/dvip3-1024w.webp 1024w" sizes="100vw" alt="dvip3">' > html-templates/dvip3.html
        echo '<img src="/dvip4/resized/dvip4-640w.webp" srcset="/dvip4/resized/dvip4-320w.webp 320w, /dvip4/resized/dvip4-640w.webp 640w, /dvip4/resized/dvip4-1024w.webp 1024w" sizes="100vw" alt="dvip4">' > html-templates/dvip4.html
        echo '<img src="/dvipicon/dvipicon512.webp" srcset="/dvipicon/resized/dvipicon48.webp 48w, /dvipicon/resized/dvipicon180.webp 180w, /dvipicon/resized/dvipicon512.webp 512w" sizes="48px" alt="icon">' > html-templates/dvipicon.html
    
    - name: Show results
      run: |
        echo "=== GENERATED FILES ==="
        ls -la dvip1/resized/ 2>/dev/null || echo "No dvip1 images"
        ls -la dvip2/resized/ 2>/dev/null || echo "No dvip2 images"
        ls -la dvip3/resized/ 2>/dev/null || echo "No dvip3 images"
        ls -la dvip4/resized/ 2>/dev/null || echo "No dvip4 images"
        ls -la dvipicon/resized/ 2>/dev/null || echo "No icon images"
        echo "=== HTML TEMPLATES ==="
        ls -la html-templates/ 2>/dev/null || echo "No HTML files"
    
    - name: Commit changes
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        if git diff --cached --quiet; then
          echo "No changes"
        else
          git commit -m "Generated responsive images"
          git push
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Generate WordPress Style Images

on:
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install dependencies
      run: pip install Pillow
    
    - name: Create WordPress folders
      run: |
        mkdir -p dvip1 dvip2 dvip3 dvip4 dvipicon
        mkdir -p dvip1/resized dvip2/resized dvip3/resized dvip4/resized dvipicon/resized
    
    - name: Generate WordPress format images
      run: |
        python3 << 'EOF'
import json
from PIL import Image
import os

print("üöÄ Generating WordPress-style images...")

# Load config
with open('image-sizes.json') as f:
    config = json.load(f)

# Process each image
images = [
    ('dvip1', 'dvip1.webp'),
    ('dvip2', 'dvip2.webp'),
    ('dvip3', 'dvip3.webp'),
    ('dvip4', 'dvip4.webp'),
    ('dvipicon', 'dvipicon512.webp')
]

for folder, source in images:
    print(f"\nüìÅ Processing: {folder}")
    
    if not os.path.exists(source):
        print(f"  ‚ö†Ô∏è  Missing: {source}")
        continue
    
    # Copy original to folder
    os.makedirs(folder, exist_ok=True)
    if not os.path.exists(f"{folder}/{source}"):
        import shutil
        shutil.copy2(source, f"{folder}/{source}")
        print(f"  ‚úì Original copied")
    
    # Open image
    img = Image.open(source)
    if img.mode != 'RGB':
        img = img.convert('RGB')
    
    orig_w, orig_h = img.size
    print(f"  Original: {orig_w}x{orig_h}")
    
    # Get sizes for this image
    if folder in config['custom_sizes']:
        sizes = config['custom_sizes'][folder]
    elif folder == 'dvipicon':
        sizes = config['custom_sizes']['dvipicon']
    else:
        # Use standard sizes for other images
        sizes = []
        for size in config['sizes']:
            if size['width'] <= orig_w:
                # Calculate proportional height
                ratio = size['width'] / orig_w
                height = int(orig_h * ratio)
                sizes.append({"width": size['width'], "height": height})
    
    # Generate each size
    for size in sizes:
        w = size['width']
        h = size['height']
        
        # WordPress format: name-widthxheight.webp
        filename = f"{folder}-{w}x{h}.webp"
        output = f"{folder}/resized/{filename}"
        
        # Resize and save
        resized = img.resize((w, h), Image.Resampling.LANCZOS)
        resized.save(output, 'WEBP', 
                    quality=config['quality'],
                    optimize=True)
        
        print(f"  ‚úì {filename}")
    
    img.close()

print("\n‚úÖ WordPress images generated!")
print("üìÅ Check each folder's /resized/ subfolder")
EOF
    
    - name: List generated files
      run: |
        echo "=========================================="
        echo "   WORDPRESS FORMAT IMAGES GENERATED     "
        echo "=========================================="
        echo ""
        
        echo "üìÅ DVIP1 (Example from your screenshot):"
        echo "  Original: dvip1.webp"
        echo "  Generated in dvip1/resized/:"
        ls dvip1/resized/*.webp 2>/dev/null | while read f; do
          name=$(basename "$f")
          size=${name:5:-5}  # Remove 'dvip1-' and '.webp'
          echo "    - $name  ‚Üí  $size"
        done || echo "    No files yet"
        
        echo ""
        echo "üìÅ DVIPICON (Square icons):"
        echo "  Originals: dvipicon48.webp, dvipicon180.webp, dvipicon512.webp"
        echo "  Generated in dvipicon/resized/:"
        ls dvipicon/resized/*.webp 2>/dev/null | while read f; do
          name=$(basename "$f")
          echo "    - $name"
        done || echo "    No files yet"
        
        echo ""
        echo "üìÅ OTHER FOLDERS:"
        for dir in dvip2 dvip3 dvip4; do
          if [ -d "$dir/resized" ]; then
            count=$(ls -1 "$dir/resized/"*.webp 2>/dev/null | wc -l)
            echo "  $dir/resized/: $count WordPress sizes"
          fi
        done
    
    - name: Commit WordPress images
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Add all WordPress format images
        git add dvip1/resized/* dvip2/resized/* dvip3/resized/* dvip4/resized/* dvipicon/resized/*
        
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "üñºÔ∏è Generated WordPress format images"
          git push
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

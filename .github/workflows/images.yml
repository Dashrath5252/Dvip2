name: Process Images

on:
  workflow_dispatch:

jobs:
  process:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install Pillow properly
      run: |
        python -m pip install --upgrade pip
        pip install pillow
    
    - name: Verify Pillow installation
      run: |
        python -c "import PIL; print(f'Pillow version: {PIL.__version__}')"
    
    - name: Create directories
      run: |
        mkdir -p dvip1/resized dvip2/resized dvip3/resized dvip4/resized dvipicon/resized
    
    - name: Process images using simple commands
      run: |
        # Instead of complex Python, use simple ImageMagick
        sudo apt-get update
        sudo apt-get install -y webp
        
        # Convert dvip1
        if [ -f "dvip1.webp" ]; then
          echo "Processing dvip1..."
          # Get dimensions
          python3 -c "
from PIL import Image
img = Image.open('dvip1.webp')
w, h = img.size
print(f'Original: {w}x{h}')
for size in [320, 640, 1024]:
    if size < w:
        ratio = size / w
        new_h = int(h * ratio)
        resized = img.resize((size, new_h))
        resized.save(f'dvip1/resized/dvip1-{size}w.webp', 'WEBP', quality=85)
        print(f'Created: dvip1-{size}w.webp ({size}x{new_h})')
img.close()
"
        fi
        
        # Convert dvip2
        if [ -f "dvip2.webp" ]; then
          echo "Processing dvip2..."
          python3 -c "
from PIL import Image
img = Image.open('dvip2.webp')
w, h = img.size
print(f'Original: {w}x{h}')
for size in [320, 640, 1024]:
    if size < w:
        ratio = size / w
        new_h = int(h * ratio)
        resized = img.resize((size, new_h))
        resized.save(f'dvip2/resized/dvip2-{size}w.webp', 'WEBP', quality=85)
        print(f'Created: dvip2-{size}w.webp ({size}x{new_h})')
img.close()
"
        fi
        
        # Convert dvip3
        if [ -f "dvip3.webp" ]; then
          echo "Processing dvip3..."
          python3 -c "
from PIL import Image
img = Image.open('dvip3.webp')
w, h = img.size
print(f'Original: {w}x{h}')
for size in [320, 640, 1024]:
    if size < w:
        ratio = size / w
        new_h = int(h * ratio)
        resized = img.resize((size, new_h))
        resized.save(f'dvip3/resized/dvip3-{size}w.webp', 'WEBP', quality=85)
        print(f'Created: dvip3-{size}w.webp ({size}x{new_h})')
img.close()
"
        fi
        
        # Convert dvip4
        if [ -f "dvip4.webp" ]; then
          echo "Processing dvip4..."
          python3 -c "
from PIL import Image
img = Image.open('dvip4.webp')
w, h = img.size
print(f'Original: {w}x{h}')
for size in [320, 640, 1024]:
    if size < w:
        ratio = size / w
        new_h = int(h * ratio)
        resized = img.resize((size, new_h))
        resized.save(f'dvip4/resized/dvip4-{size}w.webp', 'WEBP', quality=85)
        print(f'Created: dvip4-{size}w.webp ({size}x{new_h})')
img.close()
"
        fi
        
        # Copy icons
        echo "Copying icons..."
        cp dvipicon48.webp dvipicon/resized/ 2>/dev/null || true
        cp dvipicon180.webp dvipicon/resized/ 2>/dev/null || true
        cp dvipicon512.webp dvipicon/resized/ 2>/dev/null || true
    
    - name: Show results
      run: |
        echo "=== Generated Files ==="
        find . -type f -name "*.webp" | grep resized || echo "No resized images found"
    
    - name: Commit
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        if git diff --cached --quiet; then
          echo "No changes"
        else
          git commit -m "Add resized images"
          git push
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Simple Image Resizer

on: workflow_dispatch

jobs:
  resize:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup ImageMagick
      run: |
        sudo apt-get update
        sudo apt-get install -y webp imagemagick
    
    - name: Create directories
      run: |
        mkdir -p dvip1/resized dvip2/resized dvip3/resized dvip4/resized dvipicon/resized
    
    - name: Resize using cwebp (native tool)
      run: |
        echo "Using cwebp for conversion..."
        
        # Function to resize
        resize_webp() {
          local input=$1
          local output=$2
          local width=$3
          
          if [ -f "$input" ]; then
            # Get original height to calculate ratio
            info=$(identify "$input" 2>/dev/null | awk '{print $3}')
            orig_w=$(echo $info | cut -d'x' -f1)
            orig_h=$(echo $info | cut -d'x' -f2)
            
            if [ -n "$orig_w" ] && [ "$width" -lt "$orig_w" ]; then
              height=$((orig_h * width / orig_w))
              cwebp -q 85 -resize $width $height "$input" -o "$output" 2>/dev/null && echo "Created: $output"
            fi
          fi
        }
        
        # Process each image
        for i in 1 2 3 4; do
          input="dvip$i.webp"
          if [ -f "$input" ]; then
            echo "Processing $input..."
            for size in 320 640 1024; do
              output="dvip$i/resized/dvip$i-${size}w.webp"
              resize_webp "$input" "$output" $size
            done
          fi
        done
        
        # Copy icons
        cp dvipicon*.webp dvipicon/resized/ 2>/dev/null || true
        echo "Icons copied"
    
    - name: Create HTML templates
      run: |
        mkdir -p html-templates
        
        for i in 1 2 3 4; do
          if [ -d "dvip$i/resized" ]; then
            cat > "html-templates/dvip$i.html" << EOF
<img 
  src="/dvip$i/resized/dvip$i-640w.webp"
  srcset="/dvip$i/resized/dvip$i-320w.webp 320w,
          /dvip$i/resized/dvip$i-640w.webp 640w,
          /dvip$i/resized/dvip$i-1024w.webp 1024w"
  sizes="100vw"
  alt="dvip$i"
  loading="lazy"
>
EOF
            echo "Created html-templates/dvip$i.html"
          fi
        done
        
        # Icon HTML
        cat > "html-templates/dvipicon.html" << EOF
<img 
  src="/dvipicon/dvipicon512.webp"
  srcset="/dvipicon/resized/dvipicon48.webp 48w,
          /dvipicon/resized/dvipicon180.webp 180w,
          /dvipicon/resized/dvipicon512.webp 512w"
  sizes="48px"
  alt="icon"
  width="512"
  height="512"
>
EOF
    
    - name: Commit
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"
        git add .
        git commit -m "Resized images" || exit 0
        git push || exit 0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
